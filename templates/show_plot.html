<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
   <title>Price Histogram</title>
   <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" />
   <script src="https://cdn.tailwindcss.com"></script>
   <!-- Include ECharts -->
   <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
   <!-- Include Tippy.js para tooltips -->
   <script src="https://unpkg.com/@popperjs/core@2"></script>
   <script src="https://unpkg.com/tippy.js@6"></script>
   <style>
      #chart-container {
         width: 100%;
         height: 400px;
      }
      .chart-tab-active {
         background-color: #3b82f6;
         color: white;
      }
      .chart-tab {
         transition: all 0.3s ease;
      }
      .chart-content {
         display: none;
      }
      .chart-content.active {
         display: block;
      }
      .country-badge {
         display: inline-flex;
         align-items: center;
         gap: 0.5rem;
         padding: 0.25rem 0.75rem;
         border-radius: 9999px;
         background-color: rgba(255, 255, 255, 0.2);
         margin-top: 0.5rem;
      }
      .country-badge img {
         width: 20px;
         height: 14px;
      }
      .filter-info {
         display: inline-flex;
         align-items: center;
         justify-content: center;
         width: 18px;
         height: 18px;
         border-radius: 50%;
         background-color: rgba(255, 255, 255, 0.3);
         color: #2563eb;
         font-size: 12px;
         font-weight: bold;
         cursor: pointer;
         margin-left: 4px;
      }
      .tippy-box {
         background-color: #fff;
         color: #333;
         border: 1px solid #e2e8f0;
         border-radius: 0.375rem;
         box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
         padding: 0.5rem;
         max-width: 300px !important;
      }
      .tippy-box .tippy-content {
         padding: 0.5rem;
      }
      .filter-help-panel {
         background-color: rgba(245, 247, 250, 0.9);
         border: 1px solid #e2e8f0;
         border-radius: 0.375rem;
         padding: 1rem;
         margin-bottom: 1rem;
         font-size: 0.875rem;
      }
   </style>
</head>
<body class="bg-gradient-to-r from-blue-50 to-blue-100 min-h-screen flex items-center justify-center p-6">
   <div class="bg-white shadow-lg rounded-lg overflow-hidden max-w-5xl w-full">
      <header class="bg-blue-600 text-white text-center py-6">
         <h1 class="text-4xl font-bold">Histograma de Precios</h1>
         <p class="text-sm mt-2">Precios de {{ item | upper }} en MercadoLi{{ "v" if country_code == "br" else "b" }}re</p>
         <div class="country-badge">
            <img src="https://flagcdn.com/w20/{{ country_code }}.png" srcset="https://flagcdn.com/w40/{{ country_code }}.png 2x" alt="{{ country_name }}">
            {{ country_name }}
         </div>
      </header>
      <main class="p-6">
         <!-- Información sobre filtros -->
         <div id="filter-help-panel" class="filter-help-panel hidden">
            <h4 class="font-semibold mb-2">Tipos de filtrado disponibles:</h4>
            <ul class="space-y-2">
               <li>
                  <span class="font-medium text-blue-700">Estándar:</span>
                  <span>Excluye valores atípicos (outliers) estadísticos que están más allá de 3 desviaciones estándar de la media. Ideal para una visión general de precios normales.</span>
               </li>
               <li>
                  <span class="font-medium text-blue-700">Agresivo:</span>
                  <span>Elimina productos con precios menores al 40% del precio mediano. Útil para filtrar accesorios y productos no relacionados (como un soporte de $50 cuando buscas una consola PS4).</span>
               </li>
               <li>
                  <span class="font-medium text-blue-700">Todos:</span>
                  <span>Muestra todos los productos sin filtrar, incluyendo accesorios y valores atípicos. Proporciona el panorama completo de los resultados de búsqueda.</span>
               </li>
               <li>
                  <span class="font-medium text-blue-700">Filtrado manual:</span>
                  <span>Permite examinar cada producto individualmente y elegir cuáles incluir o excluir del análisis.</span>
               </li>
            </ul>
            <button id="close-filter-help" class="mt-2 text-blue-600 underline text-sm">Cerrar</button>
         </div>

         <!-- Chart Tabs -->
         <div class="flex border-b mb-4">
            <button class="chart-tab chart-tab-active py-2 px-4 font-medium rounded-t-lg" data-target="interactive">
               Gráfico Interactivo
            </button>
            <button class="chart-tab py-2 px-4 font-medium rounded-t-lg" data-target="static">
               Gráfico Estático
            </button>
         </div>

         <!-- Interactive Chart (ECharts) -->
         <div class="chart-content active" id="interactive-content">
            <div 
               id="chart-container" 
               data-prices="{{ prices_json }}"
               data-outliers="{{ outliers_json }}"
               data-item="{{ item }}"
               data-url="{{ url }}"
               data-date="{{ current_date }}"
               data-pages="{{ number_of_pages }}"
               data-failed="{{ failed_pages }}"
               data-median="{{ median_price }}"
               data-avg="{{ avg_price }}"
               data-max="{{ max_price }}"
               data-min="{{ min_price }}" 
               data-std="{{ std_dev }}"
               data-percentile25="{{ percentile_25 }}"
               data-exchange="{{ exchange_rate }}"
               data-currency="{{ currency }}"
               data-country="{{ country_name }}"
               data-country-code="{{ country_code }}"
               class="rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 mb-6"
            ></div>
         </div>

         <!-- Static Chart (Original) -->
         <div class="chart-content" id="static-content">
            <div class="flex justify-center mb-6">
               <img
                  src="data:image/png;base64,{{ plot_base64 }}"
                  alt="Price Histogram"
                  class="rounded-lg shadow-md hover:scale-105 transition-transform duration-300 max-w-full h-auto"
               />
            </div>
         </div>

         <div class="grid grid-cols-2 gap-4 text-center">
            <div class="bg-blue-50 p-4 rounded-lg shadow">
               <p class="text-lg font-semibold text-blue-600">Mediana</p>
               <p class="text-xl font-bold">{{ median_price | format_number }} {{ currency }}</p>
               <p class="text-sm text-gray-500">({{ median_price_usd | format_number }} USD)</p>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg shadow">
               <p class="text-lg font-semibold text-blue-600">Promedio</p>
               <p class="text-xl font-bold">{{ avg_price | format_number }} {{ currency }}</p>
               <p class="text-sm text-gray-500">({{ avg_price_usd | format_number }} USD)</p>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg shadow">
               <p class="text-lg font-semibold text-blue-600">Máximo</p>
               <p class="text-xl font-bold">{{ max_price | format_number }} {{ currency }}</p>
               <p class="text-sm text-gray-500">({{ max_price_usd | format_number }} USD)</p>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg shadow">
               <p class="text-lg font-semibold text-blue-600">Mínimo</p>
               <p class="text-xl font-bold">{{ min_price | format_number }} {{ currency }}</p>
               <p class="text-sm text-gray-500">({{ min_price_usd | format_number }} USD)</p>
            </div>
         </div>
         <div class="mt-6 flex justify-center gap-4">
            <a
               href="{{ url_for('index') }}"
               class="bg-blue-200 text-blue-800 py-2 px-4 rounded-lg shadow hover:bg-blue-300 transition duration-300"
            >
               Volver
            </a>
            <a
               href="data:image/png;base64,{{ plot_base64 }}"
               download="{{ item }}_price_histogram_MercadoLi{{ 'v' if country_code == 'br' else 'b' }}re_{{ country_code }}_{{ current_date }}_{{ number_of_pages }}_pages.png"
               class="bg-green-200 text-green-800 py-2 px-4 rounded-lg shadow hover:bg-green-300 transition duration-300"
               id="download-btn"
            >
               Descargar gráfico
            </a>
            <a
               href="{{ url }}"
               target="_blank"
               class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg shadow hover:bg-gray-300 transition duration-300"
            >
               Ver en MercadoLi{{ "v" if country_code == "br" else "b" }}re
            </a>
         </div>
      </main>
      <footer class="bg-gray-100 text-center py-4 text-sm text-gray-500">
         &copy; 2025 PyoneerC. No afiliado a MercadoLi{{ "v" if country_code == "br" else "b" }}re.
         <a
            href="https://github.com/pyoneerC/mercado-libre-price-chart"
            target="_blank"
            class="text-blue-600 hover:underline"
         >
            Ver en GitHub
         </a>
      </footer>
   </div>
   
   <!-- Chart switching script -->
   <script>
      document.addEventListener('DOMContentLoaded', function() {
         const tabs = document.querySelectorAll('.chart-tab');
         const contents = document.querySelectorAll('.chart-content');
         
         tabs.forEach(tab => {
            tab.addEventListener('click', function() {
               // Remove active class from all tabs and contents
               tabs.forEach(t => t.classList.remove('chart-tab-active'));
               contents.forEach(c => c.classList.remove('active'));
               
               // Add active class to current tab
               this.classList.add('chart-tab-active');
               
               // Show corresponding content
               const target = this.getAttribute('data-target');
               document.getElementById(target + '-content').classList.add('active');
               
               // Refresh ECharts if switching to interactive tab
               if (target === 'interactive' && window.priceHistogramChart) {
                  window.priceHistogramChart.resize();
               }
            });
         });
         
         // Update download button for ECharts
         const downloadBtn = document.getElementById('download-btn');
         const originalHref = downloadBtn.href;
         
         tabs.forEach(tab => {
            tab.addEventListener('click', function() {
               const target = this.getAttribute('data-target');
               
               if (target === 'interactive' && window.priceHistogramChart) {
                  downloadBtn.onclick = function(e) {
                     e.preventDefault();
                     const url = window.priceHistogramChart.getDataURL({
                        backgroundColor: '#fff',
                        pixelRatio: 2
                     });
                     const a = document.createElement('a');
                     a.href = url;
                     a.download = "{{ item }}_price_histogram_interactive_{{ country_code }}_{{ current_date }}_{{ number_of_pages }}_pages.png";
                     document.body.appendChild(a);
                     a.click();
                     document.body.removeChild(a);
                  };
               } else {
                  downloadBtn.onclick = null;
                  downloadBtn.href = originalHref;
               }
            });
         });
         
         // Configurar tooltips después de que se inicialice el gráfico
         document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
               const filterControls = document.getElementById('filter-controls');
               
               if (filterControls) {
                  // Añadir botón de ayuda junto al título del filtro
                  const filterTitle = filterControls.querySelector('span.font-medium');
                  if (filterTitle) {
                     const helpButton = document.createElement('span');
                     helpButton.className = 'filter-info';
                     helpButton.textContent = '?';
                     helpButton.id = 'filter-help-button';
                     filterTitle.appendChild(helpButton);
                     
                     // Configurar el evento click para mostrar/ocultar el panel de ayuda
                     helpButton.addEventListener('click', function() {
                        const helpPanel = document.getElementById('filter-help-panel');
                        helpPanel.classList.toggle('hidden');
                     });
                  }
                  
                  // Configurar el botón para cerrar el panel de ayuda
                  const closeHelpBtn = document.getElementById('close-filter-help');
                  if (closeHelpBtn) {
                     closeHelpBtn.addEventListener('click', function() {
                        document.getElementById('filter-help-panel').classList.add('hidden');
                     });
                  }
               }
            }, 500); // Pequeño retraso para asegurar que los elementos existen
         });
      });
   </script>
   
   <!-- Include the ECharts visualization script -->
   <script src="{{ url_for('static', filename='js/chart.js') }}"></script>
</body>
</html>
